<%
include("language.html")

function urlencode_special(s)
	s = s.gsub (s, "\n", "\r\n")
	s = s.gsub (s, "([^%w ])",
		function (c) return s.format ("%%%02X", s.byte(c)) end)
	return s
end

if _SESSION["username"] ~= nil and _SESSION["currentpath"] ~= nil then
	local filename = _GET["filename"] or _POST["filename"] or nil
	local expiretime = _GET["expiretime"] or _POST["expiretime"] or ""
	local downloadlimit = _GET["downloadlimit"] or _POST["downloadlimit"] or ""
	local downloadpass = _GET["downloadpass"] or _POST["downloadpass"] or ""
	local sendmail = _GET["sendmail"] or _POST["sendmail"] or ""
	local mailaddress = _GET["mailaddress"] or _POST["mailaddress"] or ""
	local sender_mailaddress = _GET["sender_mailaddress"] or _POST["sender_mailaddress"] or ""
	local mail_message = _GET["mail_message"] or _POST["mail_message"] or ""
	local localaddress = _GET["localaddress"] or _POST["localaddress"] or ""
	local is_dir = _GET["is_dir"] or _POST["is_dir"] or nil
	local nowdir = _GET["nowdir"] or _POST["nowdir"] or nil

	if nowdir == nil then
		nowdir = string.gsub(_SESSION["currentpath"],":{{","%[")
		nowdir = string.gsub(nowdir,"}}:","%]")
	end

	if filename ~= nil then
		if downloadlimit == "" then
			downloadlimit = "-1"
		end
		local result = c_UpdateWebLink(_SESSION["username"], filename, nowdir, expiretime, downloadlimit, downloadpass, mailaddress, sender_mailaddress)
		if result ~= "" and result ~= "noperm" then
			c_AddWebLog("User '".._SESSION["username"].."' updated Web-Link for '"..filename.."'",_SESSION_ID,DOMAIN_LOG_WEB_RESPOND)

			if sendmail == "yes" and mailaddress ~= "" and localaddress ~= "" then
				local weblink = Split(c_GetWebLink(_SESSION["username"],filename,nowdir), "\r\n")
				local url = specialhtml_encode(localaddress).."?download&weblink="..weblink[1].."&realfilename="..urlencode_special(filename)
				local urltext = specialhtml_encode(localaddress).."?download&weblink="..weblink[1].."&realfilename="..urlencode_special(filename)
				if is_dir == "yes" then
					url = specialhtml_encode(localaddress).."?download&weblink="..weblink[1]
					urltext = specialhtml_encode(localaddress).."?download&weblink="..weblink[1]
				end
				local subject = LANG["send_file_tip"].." (Wing FTP Server)"
				if sender_mailaddress == "" then
					subject = _SESSION["username"].." "..subject
				else
					subject = specialhtml_encode(sender_mailaddress).." "..subject
				end

				local message = ""

				if mail_message ~= "" then
					local msg = specialhtml_encode(mail_message)
					msg = msg.gsub(msg, "\n", "<br>")
					message = "<tr><td height='30'>"..LANG["str_field_message"]..":</td><td height='30' style='word-break:break-all;'>"..msg.."</td></tr>"
				end

				local content = [[
									<html>
									<head>
									<title>Wing FTP Server - Weblink Download</title>
									<meta http-equiv='Content-Type' content='text/html; charset=utf-8' />
									<style type='text/css'>
									<!--
									body{
									font-family: Tahoma, sans-serif;
									text-align: center;
									font-size:11px;
									font-weight:bold;
									color:#000000;
									overflow: auto;
									}
									#filelist{ border-collapse:collapse; margin:0px;}
									#filelist td{ border:solid 1px #eaeaea; padding:11px 20px;}
									#footer a:link,#footer a:visited,#footer a:active,#footer a:hover{color: #000;text-decoration:none;}
									-->
									</style>

									</head>
									<body>
									<table width='100%' border='0' cellpadding='0' cellspacing='0'>
									  <tr> 
										<td align='left' valign='top' style='padding-top:10px;'> 
										<table width='100%' border='0' align='center' cellpadding='0' cellspacing='0' style='max-width: 980px; _width: 980px;'>
											<tr>
												<td style='background:#FFF;' height='88'>
													<a href='https://www.wftpserver.com/' target='_blank'><img src='https://www.wftpserver.com/images/logo_s.png' border='0'></a>
													<hr />
												</td>
											</tr>
											<tr> 
											  <td style='background:#FFF;' valign='top'>
													<table width='100%' border='0' align='center' cellpadding='0' cellspacing='3' id='filelist' style='padding-top:10px; table-layout:fixed;'>
														<tr> 
														  <td height='30' width='30%' nowrap='nowrap'>]]..LANG["uploadstat_filename"]..[[</td><td height='30'>]]..specialhtml_encode(filename)..[[</td>
														</tr>
														<tr> 
														  <td height='30'>]]..LANG["geturl_title"]..[[:</td><td height='30' style='word-break:break-all;'><a href=']]..url..[['>]]..urltext..[[</a></td>
														</tr>
														<tr> 
														  <td height='30'>]]..LANG["password"]..[[</td><td height='30'><b>]]..specialhtml_encode(downloadpass)..[[</b></td>
														</tr>
														<tr> 
														  <td height='120' colspan='2' align='center'><a href=']]..url..[[' style='border-radius:5px; background-color:#007BFF; color:#FFF; padding:8 20px; text-decoration:none;'>&nbsp;&nbsp;]]..LANG["button_downpicture"]..[[&nbsp;&nbsp;</a></td>
														</tr>
														]]..message..[[
													</table>
												</td>
											</tr>
										  </table></td>
									  </tr>
									</table>
									</body>
									</html>
				]]
				local result = c_SendMessage(mailaddress, subject, content, true, sender_mailaddress)
				if result == false then
					print("Error: sending email")
				else
					print("operation successful")
				end
			end
		else
			print("Error: no permission")
		end
	else
		print("")
	end
end

%>