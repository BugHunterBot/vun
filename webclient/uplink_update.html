<%
include("language.html")

if _SESSION["username"] ~= nil and _SESSION["currentpath"] ~= nil then
	local filename = _GET["filename"] or _POST["filename"] or nil
	local expiretime = _GET["expiretime"] or _POST["expiretime"] or ""
	local uploadpass = _GET["uploadpass"] or _POST["uploadpass"] or ""
	local notify = _GET["notify"] or _POST["notify"] or ""
	local sendmail = _GET["sendmail"] or _POST["sendmail"] or ""
	local mailaddress = _GET["mailaddress"] or _POST["mailaddress"] or ""
	local sender_mailaddress = _GET["sender_mailaddress"] or _POST["sender_mailaddress"] or ""
	local mail_message = _GET["mail_message"] or _POST["mail_message"] or ""
	local localaddress = _GET["localaddress"] or _POST["localaddress"] or ""
	local nowdir = _GET["nowdir"] or _POST["nowdir"] or nil

	if nowdir == nil then
		nowdir = string.gsub(_SESSION["currentpath"],":{{","%[")
		nowdir = string.gsub(nowdir,"}}:","%]")
	end

	if filename ~= nil then
		local result = c_UpdateUploadLink(_SESSION["username"], filename, nowdir, expiretime, uploadpass, mailaddress, sender_mailaddress)
		if result ~= "" and result ~= "noperm" then
			c_AddWebLog("User '".._SESSION["username"].."' updated Upload-Link for the folder '"..nowdir.."/"..filename.."'",_SESSION_ID,DOMAIN_LOG_WEB_RESPOND)

			if sendmail == "yes" and mailaddress ~= "" and localaddress ~= "" then
				local UploadLink = Split(c_GetUploadLink(_SESSION["username"],filename,nowdir), "\r\n")
				local url = specialhtml_encode(localaddress).."/uploadlink.html?linkid="..UploadLink[1]
				local urltext = specialhtml_encode(localaddress).."/uploadlink.html?linkid="..UploadLink[1]
				local subject = LANG["request_file_tip"].." (Wing FTP Server)"
				if sender_mailaddress == "" then
					subject = _SESSION["username"].." "..subject
				else
					subject = specialhtml_encode(sender_mailaddress).." "..subject
				end

				local message = ""

				if mail_message ~= "" then
					local msg = specialhtml_encode(mail_message)
					msg = msg.gsub(msg, "\n", "<br>")
					message = "<tr><td height='30'>"..LANG["str_field_message"]..":</td><td height='30' style='word-break:break-all;'>"..msg.."</td></tr>"
				end

				local content = [[
									<html>
									<head>
									<title>Wing FTP Server - File Request</title>
									<meta http-equiv='Content-Type' content='text/html; charset=utf-8' />
									<style type='text/css'>
									<!--
									body{
									font-family: Tahoma, sans-serif;
									text-align: center;
									font-size:11px;
									font-weight:bold;
									color:#000000;
									overflow: auto;
									}
									#footer a:link,#footer a:visited,#footer a:active,#footer a:hover{color: #000;text-decoration:none;}
									-->
									</style>

									</head>
									<body>
									<table width='100%' border='0' cellpadding='0' cellspacing='0'>
									  <tr> 
										<td align='center' valign='top' style='padding-top:10px;'> 
										<table width='580' height='380' border='0' align='center' cellpadding='0' cellspacing='0'>
											<tr>
												<td style='background:#FFF;' height='88'>
													<a href='https://www.wftpserver.com/' target='_blank'><img src='https://www.wftpserver.com/images/logo_s.png' border='0'></a>
													<hr />
												</td>
											</tr>
											<tr> 
											  <td style='background:#FFF;' valign='top'>
													<table width='100%' border='0' align='center' cellpadding='0' cellspacing='3' style='padding-top:10px; table-layout:fixed;'>
														<tr> 
														  <td height='30' width='30%'>]]..LANG["upload_title"]..[[:</td><td height='30' style='word-break:break-all;'><a href=']]..url..[['>]]..urltext..[[</a></td>
														</tr>
														<tr> 
														  <td height='30'>]]..LANG["password"]..[[</td><td height='30'><b>]]..specialhtml_encode(uploadpass)..[[</b></td>
														</tr>
														<tr> 
														  <td height='120' colspan='2' align='center'><a href=']]..url..[[' style='border-radius:5px; background-color:#007BFF; color:#FFF; padding:8 20px; text-decoration:none;'>]]..LANG["upload_title"]..[[</a></td>
														</tr>
														]]..message..[[
													</table>
												</td>
											</tr>
										  </table></td>
									  </tr>
									</table>
									</body>
									</html>
				]]
				local result = c_SendMessage(mailaddress, subject, content, true, sender_mailaddress)
				if result == false then
					print("Error: sending email")
				else
					print("operation successful")
				end
			end
		else
			print("Error: no permission")
		end
	else
		print("")
	end
end

%>